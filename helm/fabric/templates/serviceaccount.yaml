{{ $namespace := default dict .Values.namespace }}
{{ $serviceAccount := default dict .Values.serviceAccount }}
{{ $global := default dict .Values.global }}
{{ $labels := $global.labels | default (list) }}
{{ $global_annotations := $global.annotations | default (list) }}
{{ $serviceAccount_annotations := $serviceAccount.annotations | default (list) }}

{{ if $serviceAccount.create | default false }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ default .Release.Name $namespace.name }}-sa
  namespace: {{ default .Release.Name $namespace.name }}
  labels:
    app: fabric
    {{- range $label := $labels }}
    {{ $label.name }}: {{ $label.value }}
    {{- end }}
  annotations:
    {{- if eq $serviceAccount.provider "aws" }}
    eks.amazonaws.com/role-arn: "{{ $serviceAccount.arn }}"
    {{- else if eq $serviceAccount.provider "gcp" }}
    iam.gke.io/gcp-service-account: "{{ ternary $serviceAccount.gcp_service_account_name (printf "%s-space-sa@%s.iam.gserviceaccount.com" $serviceAccount.cluster_name $serviceAccount.project_id) (not (empty $serviceAccount.gcp_service_account_name)) }}"
    {{- else if eq $serviceAccount.provider "azure" }}
    azure.workload.identity/client-id: "{{ $serviceAccount.azure_client_id }}"
    {{- end }}
    {{- if or $global_annotations $serviceAccount_annotations }}
    {{- range $annotation := $global_annotations }}
    {{ $annotation.key }}: {{ $annotation.value | quote }}
    {{- end }}
    {{- range $annotation := $serviceAccount_annotations }}
    {{ $annotation.key }}: {{ $annotation.value | quote }}
    {{- end }}
    {{- end }}
{{ end }}